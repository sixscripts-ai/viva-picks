<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | Viva Picks</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav>
        <div class="container">
            <div class="logo">
                <div class="logo-icon">V</div>
                Viva Picks
            </div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="account.html" style="color: #fff;">My Account</a>
                <a href="#" id="logout-btn-nav" class="btn btn-outline"
                    style="padding: 0.5rem 1rem; font-size: 0.8rem;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container" style="padding-top: 80px; min-height: 100vh;">
        <h1 style="margin-bottom: 2rem;">My Account</h1>

        <div style="display: grid; gap: 2rem;">
            <!-- Profile Info -->
            <div class="glass-panel" style="padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">ðŸ‘¤</span> Profile
                </h2>
                <div style="display: grid; gap: 1rem; color: var(--text-muted);">
                    <div>
                        <span style="display: block; font-size: 0.8rem; margin-bottom: 0.2rem;">Email Address</span>
                        <span id="user-email"
                            style="color: #fff; font-size: 1.1rem; font-weight: 500;">loading...</span>
                    </div>
                    <div>
                        <span style="display: block; font-size: 0.8rem; margin-bottom: 0.2rem;">Member ID</span>
                        <span id="user-id" style="color: #fff; font-family: monospace;">loading...</span>
                    </div>
                </div>
            </div>

            <!-- Subscription Status -->
            <div class="glass-panel" style="padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">ðŸ’³</span> Subscription
                </h2>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <div style="margin-bottom: 0.5rem; color: var(--text-muted);">Current Status</div>
                        <div id="sub-status" style="font-size: 1.5rem; font-weight: 700;">loading...</div>
                    </div>

                    <button id="billing-btn" class="btn btn-primary">
                        Manage Billing
                    </button>
                </div>

                <p id="billing-note"
                    style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted); display: none;">
                    * You can update your payment method, view invoices, or cancel your subscription via the Stripe
                    Customer Portal.
                </p>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Load User Data
            try {
                const res = await fetch('/api/auth/me');
                if (!res.ok) throw new Error('Auth failed');
                const user = await res.json();

                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-id').textContent = user.id;

                const statusEl = document.getElementById('sub-status');
                if (user.role === 'admin') {
                    statusEl.textContent = 'ADMINISTRATOR';
                    statusEl.style.color = 'var(--primary)';
                    document.getElementById('billing-btn').style.display = 'none';
                } else if (user.subscriptionStatus === 'active') {
                    statusEl.textContent = 'ACTIVE';
                    statusEl.style.color = 'var(--accent)';
                    document.getElementById('billing-note').style.display = 'block';
                } else {
                    statusEl.textContent = 'INACTIVE';
                    statusEl.style.color = '#ff5252';
                    document.getElementById('billing-btn').textContent = 'Subscribe Now';
                }

                // Handle Billing Button
                document.getElementById('billing-btn').addEventListener('click', async () => {
                    if (user.subscriptionStatus !== 'active' && user.role !== 'admin') {
                        // Subscribe flow
                        try {
                            const res = await fetch('/api/create-checkout-session', { method: 'POST' });
                            const data = await res.json();
                            if (data.url) window.location.href = data.url;
                        } catch (e) { alert('Error starting subscription'); }
                    } else {
                        // Portal flow
                        const btn = document.getElementById('billing-btn');
                        btn.textContent = 'Loading Portal...';
                        btn.disabled = true;
                        try {
                            const res = await fetch('/api/create-portal-session', { method: 'POST' });
                            const data = await res.json();
                            if (data.url) {
                                window.location.href = data.url;
                            } else {
                                alert(data.error || 'Could not access billing portal');
                                btn.textContent = 'Manage Billing';
                                btn.disabled = false;
                            }
                        } catch (e) {
                            alert('Connection error');
                            btn.textContent = 'Manage Billing';
                            btn.disabled = false;
                        }
                    }
                });

            } catch (err) {
                window.location.href = 'login.html';
            }

            // Logout
            document.getElementById('logout-btn-nav').addEventListener('click', async (e) => {
                e.preventDefault();
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = 'index.html';
            })
        });
    </script>
</body>

</html>